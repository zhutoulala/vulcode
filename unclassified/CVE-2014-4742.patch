From 8f1b18150cc2a8f27c96d9c4f94a81022fbb61e3 Mon Sep 17 00:00:00 2001
From: sidler <sidler@mulchprod.de>
Date: Sun, 8 Jun 2014 21:55:30 +0200
Subject: [PATCH] BUG / SECURITY: module_system | class_link -> fixed some rare
 conditions where a possible xss injection was possible for the systemid-param

---
 module_system/system/class_link.php | 16 +++++++++++-----
 1 file changed, 11 insertions(+), 5 deletions(-)

diff --git a/module_system/system/class_link.php b/module_system/system/class_link.php
index 7bf0f2424..4badfcae6 100644
--- a/module_system/system/class_link.php
+++ b/module_system/system/class_link.php
@@ -347,10 +347,12 @@ public static function getLinkPortalHref($strPageI, $strPageE = "", $strAction =
 
 
         //create an array out of the params
-        $strParsedSystemid = "";
-        $arrParams = self::parseParamsString($strParams, $strParsedSystemid);
-        if($strSystemid == "" && validateSystemid($strParsedSystemid))
-            $strSystemid = $strParsedSystemid;
+        if($strSystemid != "") {
+            $strParams .= "&systemid=".$strSystemid;
+            $strSystemid = "";
+        }
+
+        $arrParams = self::parseParamsString($strParams, $strSystemid);
 
         // any anchors set to the page?
         $strAnchor = "";
@@ -496,7 +498,11 @@ private static function parseParamsString($strParams, &$strSystemid = "") {
             $arrEntry = explode("=", $strValue);
 
             if(count($arrEntry) == 2 && $arrEntry[0] == "systemid") {
-                $strSystemid = $arrEntry[1];
+                //encoded and sanitized systemid param TODO: add cve number or other identifier
+                $strSystemid = urlencode($arrEntry[1]);
+                if(!validateSystemid($strSystemid))
+                    $strSystemid = "";
+
                 unset($arrParams[$strKey]);
             }
             else if($strValue == "")
