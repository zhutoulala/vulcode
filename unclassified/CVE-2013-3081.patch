From 972757c4500d94b4b1306bf092e678add3a987d8 Mon Sep 17 00:00:00 2001
From: Harvey Kane <harvey@harveykane.com>
Date: Tue, 7 May 2013 11:09:47 +1200
Subject: [PATCH] Fix SQL injection issue CVE-2013-3081

---
 plugins/jojo_core/classes/Jojo.php | 12 ++++++++----
 1 file changed, 8 insertions(+), 4 deletions(-)

diff --git a/plugins/jojo_core/classes/Jojo.php b/plugins/jojo_core/classes/Jojo.php
index c61e1aff..c47c5dbe 100755
--- a/plugins/jojo_core/classes/Jojo.php
+++ b/plugins/jojo_core/classes/Jojo.php
@@ -2461,14 +2461,18 @@ static function checkEmailFormat($email)
     /* Gets the IP address of the visitor, bypassing proxies */
     static function getIp()
     {
+        $ip = false;
         if ( (getenv('HTTP_X_FORWARDED_FOR') != '') && (strtolower(getenv('HTTP_X_FORWARDED_FOR')) != 'unknown')) {
             $iparray = explode(',', getenv('HTTP_X_FORWARDED_FOR'));
-            return $iparray[0];
+            $ip = $iparray[0];
         } elseif (getenv('REMOTE_ADDR') != '') {
-            return getenv('REMOTE_ADDR');
-        } else {
-            return false;
+            $ip = getenv('REMOTE_ADDR');
         }
+        /* check IP is valid format */
+        if (preg_match('/\\b(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\b/', $ip)) {
+        	return $ip;
+        }
+        return false;
     }
 
     /* reads the user agent string and gives the browser type - quick and simple detection */
